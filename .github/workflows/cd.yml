name: CD - Build and Push Images

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
  workflow_dispatch:
  push:
    tags: ['v*']

env:
  AWS_REGION: us-east-1

jobs:
  check-ci-status:
    name: Check CI Status
    runs-on: ubuntu-latest
    # Only run if CI succeeded on main/develop OR if manually triggered OR if tag push
    if: |
      (github.event_name == 'workflow_run' && 
       github.event.workflow_run.conclusion == 'success' && 
       (github.event.workflow_run.head_branch == 'main' || github.event.workflow_run.head_branch == 'develop')) ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v'))
    outputs:
      should_deploy: ${{ steps.verify.outputs.should_deploy }}
      branch: ${{ steps.verify.outputs.branch }}
    steps:
      - name: Verify trigger and CI status
        id: verify
        run: |
          echo "‚úÖ Proceeding with deployment"
          echo "Event: ${{ github.event_name }}"
          
          SHOULD_DEPLOY="true"
          BRANCH="${{ github.ref_name }}"
          
          if [ "${{ github.event_name }}" == "workflow_run" ]; then
            echo "CI Workflow: ${{ github.event.workflow_run.name }}"
            echo "CI Conclusion: ${{ github.event.workflow_run.conclusion }}"
            echo "CI Branch: ${{ github.event.workflow_run.head_branch }}"
            echo "CI Commit: ${{ github.event.workflow_run.head_sha }}"
            
            # Verify CI actually succeeded
            if [ "${{ github.event.workflow_run.conclusion }}" != "success" ]; then
              echo "‚ùå CI workflow did not succeed, cancelling deployment"
              SHOULD_DEPLOY="false"
            fi
            
            BRANCH="${{ github.event.workflow_run.head_branch }}"
          fi
          
          echo "should_deploy=$SHOULD_DEPLOY" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "Deployment decision: $SHOULD_DEPLOY for branch: $BRANCH"

  build-backend:
    name: Build Backend
    needs: [check-ci-status]
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    outputs:
      image: ${{ steps.image-info.outputs.image }}
      image_tag: ${{ steps.image-info.outputs.image_tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          # Checkout the correct ref based on trigger type
          ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || github.ref }}
      
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      
      - uses: aws-actions/amazon-ecr-login@v2
      
      - uses: docker/setup-buildx-action@v3
      
      - name: Get ECR registry
        id: ecr-registry
        run: |
          ECR_REGISTRY=$(aws sts get-caller-identity --query Account --output text)
          echo "registry_id=$ECR_REGISTRY" >> $GITHUB_OUTPUT
      
      - name: Build and push
        id: meta-backend
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.ecr-registry.outputs.registry_id }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ secrets.ECR_BACKEND_REPO }}
          tags: |
            type=sha
            type=raw,value=latest,enable={{is_default_branch}}
            type=ref,event=branch
      
      - uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: ${{ steps.meta-backend.outputs.tags }}
          labels: |
            org.opencontainers.image.source=${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Set image output
        id: image-info
        run: |
          IMAGE=$(echo "${{ steps.meta-backend.outputs.tags }}" | head -n1 | tr -d '\n' | xargs || true)
          if [ -z "$IMAGE" ]; then
            echo "‚ö†Ô∏è  Warning: Backend image output is empty, constructing from ECR..."
            ECR_REGISTRY=$(aws sts get-caller-identity --query Account --output text)
            IMAGE="${ECR_REGISTRY}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ secrets.ECR_BACKEND_REPO }}:latest"
            echo "Constructed backend image: $IMAGE"
          fi
          
          # Extract tag
          IMAGE_TAG=$(echo "$IMAGE" | cut -d':' -f2)
          if [ -z "$IMAGE_TAG" ] || [ "$IMAGE_TAG" == "$IMAGE" ]; then
            IMAGE_TAG="latest"
          fi
          
          echo "image=$IMAGE" >> $GITHUB_OUTPUT
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "‚úÖ Backend image: $IMAGE (tag: $IMAGE_TAG)"

  build-frontend:
    name: Build Frontend
    needs: [check-ci-status]
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    outputs:
      image: ${{ steps.image-info.outputs.image }}
      image_tag: ${{ steps.image-info.outputs.image_tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || github.ref }}
      
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      
      - uses: aws-actions/amazon-ecr-login@v2
      
      - uses: docker/setup-buildx-action@v3
      
      - name: Get ECR registry
        id: ecr-registry
        run: |
          ECR_REGISTRY=$(aws sts get-caller-identity --query Account --output text)
          echo "registry_id=$ECR_REGISTRY" >> $GITHUB_OUTPUT
      
      - name: Build and push
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.ecr-registry.outputs.registry_id }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ secrets.ECR_FRONTEND_REPO }}
          tags: |
            type=sha
            type=raw,value=latest,enable={{is_default_branch}}
            type=ref,event=branch
      
      - uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: |
            org.opencontainers.image.source=${{ github.repository }}
            org.opencontainers.image.revision=${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Set image output
        id: image-info
        run: |
          IMAGE=$(echo "${{ steps.meta-frontend.outputs.tags }}" | head -n1 | tr -d '\n' | xargs || true)
          if [ -z "$IMAGE" ]; then
            echo "‚ö†Ô∏è  Warning: Frontend image output is empty, constructing from ECR..."
            ECR_REGISTRY=$(aws sts get-caller-identity --query Account --output text)
            IMAGE="${ECR_REGISTRY}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ secrets.ECR_FRONTEND_REPO }}:latest"
            echo "Constructed frontend image: $IMAGE"
          fi
          
          # Extract tag
          IMAGE_TAG=$(echo "$IMAGE" | cut -d':' -f2)
          if [ -z "$IMAGE_TAG" ] || [ "$IMAGE_TAG" == "$IMAGE" ]; then
            IMAGE_TAG="latest"
          fi
          
          echo "image=$IMAGE" >> $GITHUB_OUTPUT
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "‚úÖ Frontend image: $IMAGE (tag: $IMAGE_TAG)"

  update-gitops-manifest:
    name: Update GitOps Manifest
    needs: [build-backend, build-frontend]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    steps:
      - name: Checkout Gitops-pipeline
        uses: actions/checkout@v4
        with:
          repository: SaaSInfraLab/Gitops-pipeline
          token: ${{ secrets.GITOPS_REPO_TOKEN }}
          path: gitops-repo
      
      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          yq --version
      
      - name: Update image tags in Kustomization files
        working-directory: gitops-repo
        run: |
          set -e
          
          BACKEND_IMAGE="${{ needs.build-backend.outputs.image }}"
          FRONTEND_IMAGE="${{ needs.build-frontend.outputs.image }}"
          BACKEND_TAG="${{ needs.build-backend.outputs.image_tag }}"
          FRONTEND_TAG="${{ needs.build-frontend.outputs.image_tag }}"
          
          echo "üì¶ Updating GitOps manifests with new image tags..."
          echo "  Backend: $BACKEND_IMAGE (tag: $BACKEND_TAG)"
          echo "  Frontend: $FRONTEND_IMAGE (tag: $FRONTEND_TAG)"
          
          # Extract image names (without tag)
          BACKEND_NAME=$(echo "$BACKEND_IMAGE" | cut -d':' -f1)
          FRONTEND_NAME=$(echo "$FRONTEND_IMAGE" | cut -d':' -f1)
          
          # Update base kustomization.yaml
          BASE_KUSTOM_FILE="apps/sample-saas-app/base/kustomization.yaml"
          if [ -f "$BASE_KUSTOM_FILE" ]; then
            echo "üìù Updating base kustomization.yaml..."
            yq eval ".images[0].newName = \"$BACKEND_NAME\"" -i "$BASE_KUSTOM_FILE"
            yq eval ".images[0].newTag = \"$BACKEND_TAG\"" -i "$BASE_KUSTOM_FILE"
            yq eval ".images[1].newName = \"$FRONTEND_NAME\"" -i "$BASE_KUSTOM_FILE"
            yq eval ".images[1].newTag = \"$FRONTEND_TAG\"" -i "$BASE_KUSTOM_FILE"
            echo "‚úÖ Base kustomization updated"
          fi
          
          # Update platform overlay
          PLATFORM_KUSTOM_FILE="apps/sample-saas-app/overlays/platform/kustomization.yaml"
          if [ -f "$PLATFORM_KUSTOM_FILE" ]; then
            echo "üìù Updating platform overlay kustomization.yaml..."
            yq eval ".images[0].newName = \"$BACKEND_NAME\"" -i "$PLATFORM_KUSTOM_FILE"
            yq eval ".images[0].newTag = \"$BACKEND_TAG\"" -i "$PLATFORM_KUSTOM_FILE"
            yq eval ".images[1].newName = \"$FRONTEND_NAME\"" -i "$PLATFORM_KUSTOM_FILE"
            yq eval ".images[1].newTag = \"$FRONTEND_TAG\"" -i "$PLATFORM_KUSTOM_FILE"
            echo "‚úÖ Platform overlay updated"
          fi
          
          # Update analytics overlay
          ANALYTICS_KUSTOM_FILE="apps/sample-saas-app/overlays/analytics/kustomization.yaml"
          if [ -f "$ANALYTICS_KUSTOM_FILE" ]; then
            echo "üìù Updating analytics overlay kustomization.yaml..."
            yq eval ".images[0].newName = \"$BACKEND_NAME\"" -i "$ANALYTICS_KUSTOM_FILE"
            yq eval ".images[0].newTag = \"$BACKEND_TAG\"" -i "$ANALYTICS_KUSTOM_FILE"
            yq eval ".images[1].newName = \"$FRONTEND_NAME\"" -i "$ANALYTICS_KUSTOM_FILE"
            yq eval ".images[1].newTag = \"$FRONTEND_TAG\"" -i "$ANALYTICS_KUSTOM_FILE"
            echo "‚úÖ Analytics overlay updated"
          fi
          
          echo "‚úÖ All kustomization files updated"
      
      - name: Commit and push to GitOps repo
        working-directory: gitops-repo
        run: |
          set -e
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Check if there are any changes
          if git diff --quiet && git diff --staged --quiet; then
            echo "‚ÑπÔ∏è  No changes to commit (images may already be up to date)"
            exit 0
          fi
          
          # Show what will be committed
          echo "üìã Changes to be committed:"
          git diff --stat
          
          # Commit changes
          COMMIT_MSG="chore: update sample-saas-app images to ${{ needs.build-backend.outputs.image_tag }}"
          git add apps/sample-saas-app/
          git commit -m "$COMMIT_MSG" || {
            echo "‚ö†Ô∏è  No changes to commit (may already be up to date)"
            exit 0
          }
          
          # Push to main branch
          git push origin main || {
            echo "‚ùå Failed to push to GitOps repo"
            exit 1
          }
          
          echo "‚úÖ Successfully updated GitOps repository"
          echo "   Commit: $COMMIT_MSG"
          echo "   Flux will automatically detect and deploy the changes"
