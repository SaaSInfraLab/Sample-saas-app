name: CI

on:
  push:
    branches: [ main, develop, flus-Test ]
  pull_request:
    branches: [ main, develop, flus-Test ]

env:
  AWS_REGION: us-east-1

jobs:
  backend-test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: backend/package-lock.json
    
    - name: Install dependencies
      working-directory: ./backend
      run: npm ci
    
    - name: Run tests
      working-directory: ./backend
      run: npm test || echo "No tests configured yet"
    
    - name: Lint
      working-directory: ./backend
      run: npm run lint || echo "No lint script configured"

  frontend-test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Install dependencies
      working-directory: ./frontend
      run: npm ci
    
    - name: Build
      working-directory: ./frontend
      run: npm run build
    
    - name: Lint
      working-directory: ./frontend
      run: npm run lint || echo "No lint script configured"

  security-scan:
    name: Security & Code Quality Checks
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Secret Scanning
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      continue-on-error: true
    
    - name: Check for Hardcoded Secrets
      run: |
        echo "üîç Scanning for hardcoded secrets and credentials..."
        FOUND_ISSUES=0
        
        # Check for common secret patterns
        if grep -r -i -E "(password|secret|api[_-]?key|token|credential)\s*[=:]\s*['\"][^'\"]{8,}" \
          --include="*.js" --include="*.jsx" --include="*.ts" --include="*.tsx" \
          --exclude-dir=node_modules --exclude-dir=.git backend/ frontend/ 2>/dev/null | \
          grep -v "process.env" | grep -v "import.meta.env" | grep -v "localhost" | grep -v "changeme" | grep -v "dev-secret"; then
          echo "‚ùå Found potential hardcoded secrets!"
          grep -r -i -E "(password|secret|api[_-]?key|token|credential)\s*[=:]\s*['\"][^'\"]{8,}" \
            --include="*.js" --include="*.jsx" --include="*.ts" --include="*.tsx" \
            --exclude-dir=node_modules --exclude-dir=.git backend/ frontend/ 2>/dev/null | \
            grep -v "process.env" | grep -v "import.meta.env" | grep -v "localhost" | grep -v "changeme" | grep -v "dev-secret" || true
          FOUND_ISSUES=1
        else
          echo "‚úÖ No hardcoded secrets found"
        fi
        
        # Check for AWS keys
        if grep -r -E "(AKIA[0-9A-Z]{16}|aws_access_key|aws_secret_key)" \
          --include="*.js" --include="*.jsx" --include="*.ts" --include="*.tsx" \
          --exclude-dir=node_modules --exclude-dir=.git backend/ frontend/ 2>/dev/null; then
          echo "‚ùå Found potential AWS credentials!"
          FOUND_ISSUES=1
        fi
        
        # Check for database connection strings with passwords
        if grep -r -i -E "(postgresql://|mongodb://|mysql://).*[:@].*[:@]" \
          --include="*.js" --include="*.jsx" --include="*.ts" --include="*.tsx" \
          --exclude-dir=node_modules --exclude-dir=.git backend/ frontend/ 2>/dev/null | \
          grep -v "localhost" | grep -v "process.env"; then
          echo "‚ùå Found potential hardcoded database connection strings!"
          FOUND_ISSUES=1
        fi
        
        if [ $FOUND_ISSUES -eq 1 ]; then
          echo "‚ùå Security scan failed: Hardcoded secrets detected"
          exit 1
        fi
    
    - name: Check for Hardcoded URLs and Endpoints
      run: |
        echo "üîç Checking for hardcoded URLs and endpoints..."
        FOUND_ISSUES=0
        
        # Check for hardcoded AWS endpoints (should use environment variables)
        if grep -r -E "(\.amazonaws\.com|\.rds\.amazonaws\.com|\.eks\.amazonaws\.com)" \
          --include="*.js" --include="*.jsx" --include="*.ts" --include="*.tsx" \
          --exclude-dir=node_modules --exclude-dir=.git backend/ frontend/ 2>/dev/null | \
          grep -v "process.env" | grep -v "import.meta.env" | grep -v "\.md" | grep -v "README"; then
          echo "‚ö†Ô∏è  Warning: Found hardcoded AWS endpoints (consider using environment variables)"
          grep -r -E "(\.amazonaws\.com|\.rds\.amazonaws\.com|\.eks\.amazonaws\.com)" \
            --include="*.js" --include="*.jsx" --include="*.ts" --include="*.tsx" \
            --exclude-dir=node_modules --exclude-dir=.git backend/ frontend/ 2>/dev/null | \
            grep -v "process.env" | grep -v "import.meta.env" | grep -v "\.md" | grep -v "README" || true
        else
          echo "‚úÖ No hardcoded AWS endpoints found"
        fi
        
        # Check for hardcoded IP addresses (except localhost)
        if grep -r -E "\b([0-9]{1,3}\.){3}[0-9]{1,3}\b" \
          --include="*.js" --include="*.jsx" --include="*.ts" --include="*.tsx" \
          --exclude-dir=node_modules --exclude-dir=.git backend/ frontend/ 2>/dev/null | \
          grep -v "127.0.0.1" | grep -v "0.0.0.0" | grep -v "localhost" | grep -v "process.env"; then
          echo "‚ö†Ô∏è  Warning: Found hardcoded IP addresses"
        else
          echo "‚úÖ No hardcoded IP addresses found"
        fi
    
    - name: Check for Console Logs in Production Code
      run: |
        echo "üîç Checking for console.log statements..."
        CONSOLE_LOGS=$(find backend/src frontend/src -type f \( -name "*.js" -o -name "*.jsx" \) \
          -not -path "*/node_modules/*" -exec grep -l "console\.log" {} \; 2>/dev/null | wc -l || echo "0")
        
        if [ "$CONSOLE_LOGS" -gt 0 ]; then
          echo "‚ö†Ô∏è  Warning: Found console.log statements in source code"
          echo "Consider removing or using a proper logging library for production"
          find backend/src frontend/src -type f \( -name "*.js" -o -name "*.jsx" \) \
            -not -path "*/node_modules/*" -exec grep -Hn "console\.log" {} \; 2>/dev/null | head -10 || true
        else
          echo "‚úÖ No console.log statements found"
        fi
    
    - name: Check for TODO/FIXME Comments
      run: |
        echo "üîç Checking for TODO/FIXME comments..."
        TODO_COUNT=$(grep -r -i -E "(TODO|FIXME|XXX|HACK)" \
          --include="*.js" --include="*.jsx" --include="*.ts" --include="*.tsx" \
          --exclude-dir=node_modules --exclude-dir=.git backend/src frontend/src 2>/dev/null | wc -l || echo "0")
        
        if [ "$TODO_COUNT" -gt 0 ]; then
          echo "‚ÑπÔ∏è  Found $TODO_COUNT TODO/FIXME comments (informational only)"
          grep -r -i -E "(TODO|FIXME|XXX|HACK)" \
            --include="*.js" --include="*.jsx" --include="*.ts" --include="*.tsx" \
            --exclude-dir=node_modules --exclude-dir=.git backend/src frontend/src 2>/dev/null | head -5 || true
        else
          echo "‚úÖ No TODO/FIXME comments found"
        fi
    
    - name: Validate Environment Variable Usage
      run: |
        echo "üîç Validating environment variable usage..."
        
        # Check backend uses process.env
        if grep -r "DB_HOST\|DB_PASSWORD\|JWT_SECRET" backend/src --include="*.js" 2>/dev/null | \
          grep -v "process.env" | grep -v "require('dotenv')" | grep -v "\.env"; then
          echo "‚ö†Ô∏è  Warning: Found direct references to env vars without process.env in backend"
        else
          echo "‚úÖ Backend properly uses process.env for environment variables"
        fi
        
        # Check frontend uses import.meta.env
        if grep -r "VITE_API_URL\|API_URL" frontend/src --include="*.js" --include="*.jsx" 2>/dev/null | \
          grep -v "import.meta.env" | grep -v "process.env"; then
          echo "‚ö†Ô∏è  Warning: Found direct references to env vars without import.meta.env in frontend"
        else
          echo "‚úÖ Frontend properly uses import.meta.env for environment variables"
        fi


