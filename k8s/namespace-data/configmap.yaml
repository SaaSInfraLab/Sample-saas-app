apiVersion: v1
kind: ConfigMap
metadata:
  name: backend-config
  namespace: data
data:
  db-name: "taskdb"
  db-pool-min: "2"
  db-pool-max: "10"
  jwt-expires-in: "24h"
  metrics-enabled: "true"

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgresql-config
  namespace: data
data:
  db-name: "taskdb"

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgresql-init-scripts
  namespace: data
data:
  001_create_tenants.sql: |
    -- Create tenant schemas
    CREATE SCHEMA IF NOT EXISTS tenant_platform;
    CREATE SCHEMA IF NOT EXISTS tenant_analytics;
    CREATE SCHEMA IF NOT EXISTS tenant_data;
    
    -- Create tenant metadata table
    CREATE TABLE IF NOT EXISTS tenants (
        id SERIAL PRIMARY KEY,
        tenant_id VARCHAR(50) UNIQUE NOT NULL,
        name VARCHAR(255) NOT NULL,
        namespace VARCHAR(100) NOT NULL,
        created_at TIMESTAMP DEFAULT NOW(),
        updated_at TIMESTAMP DEFAULT NOW()
    );
    
    INSERT INTO tenants (tenant_id, name, namespace) VALUES
        ('platform', 'Platform Team', 'platform'),
        ('analytics', 'Analytics Team', 'analytics'),
        ('data', 'Data Team', 'data')
    ON CONFLICT (tenant_id) DO NOTHING;
  
  002_create_users.sql: |
    -- Create users table function
    CREATE OR REPLACE FUNCTION create_users_table(schema_name TEXT)
    RETURNS VOID AS $$
    BEGIN
        EXECUTE format('
            CREATE TABLE IF NOT EXISTS %I.users (
                id SERIAL PRIMARY KEY,
                email VARCHAR(255) UNIQUE NOT NULL,
                password_hash VARCHAR(255) NOT NULL,
                name VARCHAR(255) NOT NULL,
                tenant_id VARCHAR(50) NOT NULL,
                created_at TIMESTAMP DEFAULT NOW(),
                updated_at TIMESTAMP DEFAULT NOW()
            );
            CREATE INDEX IF NOT EXISTS idx_users_email ON %I.users(email);
        ', schema_name);
    END;
    $$ LANGUAGE plpgsql;
    
    SELECT create_users_table('tenant_platform');
    SELECT create_users_table('tenant_analytics');
    SELECT create_users_table('tenant_data');
    DROP FUNCTION IF EXISTS create_users_table(TEXT);
  
  003_create_tasks.sql: |
    -- Create tasks table function
    CREATE OR REPLACE FUNCTION create_tasks_table(schema_name TEXT)
    RETURNS VOID AS $$
    BEGIN
        EXECUTE format('
            CREATE TABLE IF NOT EXISTS %I.tasks (
                id SERIAL PRIMARY KEY,
                title VARCHAR(255) NOT NULL,
                description TEXT,
                status VARCHAR(50) DEFAULT ''todo'' CHECK (status IN (''todo'', ''in_progress'', ''done'')),
                assignee VARCHAR(255),
                due_date DATE,
                created_by INTEGER NOT NULL,
                created_at TIMESTAMP DEFAULT NOW(),
                updated_at TIMESTAMP DEFAULT NOW(),
                FOREIGN KEY (created_by) REFERENCES %I.users(id) ON DELETE CASCADE
            );
            CREATE INDEX IF NOT EXISTS idx_tasks_status ON %I.tasks(status);
        ', schema_name, schema_name);
    END;
    $$ LANGUAGE plpgsql;
    
    SELECT create_tasks_table('tenant_platform');
    SELECT create_tasks_table('tenant_analytics');
    SELECT create_tasks_table('tenant_data');
    DROP FUNCTION IF EXISTS create_tasks_table(TEXT);
